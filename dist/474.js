"use strict";(self.webpackChunkslack_clone=self.webpackChunkslack_clone||[]).push([[474],{3474:(e,t,n)=>{n.r(t),n.d(t,{default:()=>b});var r=n(7294),a=n(9498),o=n(5977),l=n(5767),c=n(3564),i=n(6182),u=n.n(i),s=n(2309),f=n(2545),d=n(8678),m=n(9669),g=n.n(m),v=n(8667),p=n(2951);function h(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,a,o=[],l=!0,c=!1;try{for(n=n.call(e);!(l=(r=n.next()).done)&&(o.push(r.value),!t||o.length!==t);l=!0);}catch(e){c=!0,a=e}finally{try{l||null==n.return||n.return()}finally{if(c)throw a}}return o}}(e,t)||function(e,t){if(e){if("string"==typeof e)return S(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?S(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function S(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}const b=function(){var e,t,n=(0,o.UO)(),i=n.workspace,m=n.id,S=(0,l.ZP)("/api/workspaces/".concat(i,"/users/").concat(m),c.Z).data,b=(0,l.ZP)("/api/users",c.Z).data,k=(0,r.useRef)(null),y=h((0,d.Z)(""),3),T=y[0],w=y[1],E=y[2],C=(0,l.g_)((function(e){return"/api/workspaces/".concat(i,"/dms/").concat(m,"/chats?perPage=20&page=").concat(e+1)}),c.Z),Z=C.data,D=C.mutate,A=C.revalidate,I=C.setSize,B=0===(null==Z||null===(e=Z[0])||void 0===e?void 0:e.length)||Z&&(null===(t=Z[Z.length-1])||void 0===t?void 0:t.length)<20||!1,O=h((0,p.Z)(i),1)[0],R=h((0,r.useState)(!1),2),j=R[0],F=R[1],P=(0,r.useCallback)((function(e){if(e.preventDefault(),null!=T&&T.trim()&&Z){var t=T;D((function(e){var n;return null==e||e[0].unshift({id:((null===(n=Z[0][0])||void 0===n?void 0:n.id)||0)+1,content:t,SenderId:b.id,Sender:b,ReceiverId:S.id,Receiver:S,createdAt:new Date}),e}),!1).then((function(){var e;E(""),null===(e=k.current)||void 0===e||e.scrollToBottom()})),g().post("/api/workspaces/".concat(i,"/dms/").concat(m,"/chats"),{content:T}).then((function(){A()})).catch(console.error)}}),[T,Z,b,S,i,m]),_=(0,r.useCallback)((function(e){e.SenderId===Number(m)&&b.id!==Number(m)&&D((function(t){return null==t||t[0].unshift(e),t}),!1).then((function(){k.current&&k.current.getScrollHeight()<k.current.getClientHeight()+k.current.getScrollTop()+150&&(console.log("scrollToBottom!",k.current.getValues()),setTimeout((function(){var e;null===(e=k.current)||void 0===e||e.scrollToBottom()}),50))}))}),[]);(0,r.useEffect)((function(){return null==O||O.on("dm",_),function(){null==O||O.off("dm",_)}}),[O,_]),(0,r.useEffect)((function(){var e;1===(null==Z?void 0:Z.length)&&(null===(e=k.current)||void 0===e||e.scrollToBottom())}),[Z]),(0,r.useEffect)((function(){localStorage.setItem("".concat(i,"-").concat(m),(new Date).getTime().toString())}),[i,m]);var x=(0,r.useCallback)((function(e){e.preventDefault(),console.log(e);var t=new FormData;if(e.dataTransfer.items){for(var n=0;n<e.dataTransfer.items.length;n++)if("file"===e.dataTransfer.items[n].kind){var r=e.dataTransfer.items[n].getAsFile();console.log("... file["+n+"].name = "+r.name),t.append("image",r)}}else for(var a=0;a<e.dataTransfer.files.length;a++)console.log("... file["+a+"].name = "+e.dataTransfer.files[a].name),t.append("image",e.dataTransfer.files[a]);g().post("/api/workspaces/".concat(i,"/dms/").concat(m,"/images"),t).then((function(){F(!1),localStorage.setItem("".concat(i,"-").concat(m),(new Date).getTime().toString()),D()}))}),[i,m,D]),z=(0,r.useCallback)((function(e){e.preventDefault(),console.log(e),F(!0)}),[]);if(!S||!b)return null;var H=(0,v.Z)(Z?Z.flat().reverse():[]);return r.createElement(a.W2,{onDrop:x,onDragOver:z},r.createElement(a.h4,null,r.createElement("img",{src:u().url(S.email,{s:"24px",d:"retro"}),alt:S.nickname}),r.createElement("span",null,S.nickname)),r.createElement(f.Z,{chatSections:H,ref:k,setSize:I,isReachingEnd:B}),r.createElement(s.Z,{chat:T,onChangeChat:w,onSubmitForm:P}),j&&r.createElement(a.KW,null,"업로드!"))}}}]);